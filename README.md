# DB Viewer

PostgreSQL ã®ãƒ€ãƒ³ãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ã‚’å¯è¦–åŒ–ãƒ»åˆ†æã™ã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‚

## ğŸ“‹ æ©Ÿèƒ½

- **ãƒ€ãƒ³ãƒ—ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**: `pg_dump` ã§ä½œæˆã—ãŸ SQL ãƒ€ãƒ³ãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- **ERå›³ç”Ÿæˆ**: ãƒ†ãƒ¼ãƒ–ãƒ«é–“ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ Mermaid.js ã§è‡ªå‹•å¯è¦–åŒ–
- **ãƒ‡ãƒ¼ã‚¿é–²è¦§**: å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèª
- **ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è§£èª¬**: FK é–¢ä¿‚ã‚’è‡ªç„¶è¨€èªã§èª¬æ˜
- **å½±éŸ¿ãƒªã‚¹ã‚¯è©•ä¾¡**: ãƒ‡ãƒ¼ã‚¿å¤‰æ›´æ™‚ã®å½±éŸ¿ç¯„å›²ã‚’ã‚¹ã‚³ã‚¢åŒ– (CASCADE ä¾å­˜ãªã©ã‚’è€ƒæ…®)
- **TTL ä»˜ãè‡ªå‹•å‰Šé™¤**: ä¸€å®šæ™‚é–“å¾Œã«ãƒ€ãƒ³ãƒ—ã‚’è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend      â”‚â”€â”€â”€â”€>â”‚   API Server    â”‚â”€â”€â”€â”€>â”‚  Metadata DB    â”‚
â”‚   (Next.js)     â”‚     â”‚   (Rust/Axum)   â”‚     â”‚  (PostgreSQL)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   Sandbox DB    â”‚
                        â”‚  (PostgreSQL)   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### å¿…è¦ãªã‚‚ã®

- [Docker](https://www.docker.com/) & Docker Compose
- [Rust](https://rustup.rs/) (1.75+)
- [Node.js](https://nodejs.org/) (20+)
- [Yarn](https://yarnpkg.com/) (4.x)

### 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³

```bash
git clone https://github.com/your-username/db-viewer.git
cd db-viewer
```

### 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’èµ·å‹•

```bash
docker-compose up -d
```

ã“ã‚Œã«ã‚ˆã‚Šä»¥ä¸‹ãŒèµ·å‹•ã—ã¾ã™:

- **Metadata DB**: localhost:5432 (ãƒ€ãƒ³ãƒ—æƒ…å ±ã€ã‚¹ã‚­ãƒ¼ãƒã‚­ãƒ£ãƒƒã‚·ãƒ¥)
- **Sandbox DB**: localhost:5433 (ãƒªã‚¹ãƒˆã‚¢ã•ã‚ŒãŸãƒ€ãƒ³ãƒ—)

### 3. ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š

```bash
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
cp backend/.env.example backend/.env

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
cp frontend/.env.example frontend/.env.local
```

### 4. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•

```bash
cd backend
cargo run --bin api-server
```

API ã‚µãƒ¼ãƒãƒ¼ãŒ <http://localhost:8080> ã§èµ·å‹•ã—ã¾ã™ã€‚

### 5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•

```bash
cd frontend
yarn install
yarn dev
```

ã‚¢ãƒ—ãƒªãŒ <http://localhost:3000> ã§èµ·å‹•ã—ã¾ã™ã€‚

## ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

```bash
db-viewer/
â”œâ”€â”€ backend/                 # Rust ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
â”‚   â”œâ”€â”€ api/                 # API ã‚µãƒ¼ãƒãƒ¼ (Axum)
â”‚   â”œâ”€â”€ core/                # ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ (ãƒ‰ãƒ¡ã‚¤ãƒ³ã€ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼)
â”‚   â”œâ”€â”€ worker/              # éåŒæœŸã‚¸ãƒ§ãƒ–ãƒ¯ãƒ¼ã‚«ãƒ¼
â”‚   â””â”€â”€ migrations/          # DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”œâ”€â”€ frontend/                # Next.js ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
â”‚   â”œâ”€â”€ src/app/             # App Router ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ src/components/      # React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â””â”€â”€ src/lib/             # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”œâ”€â”€ deploy/                  # ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š
â”‚   â””â”€â”€ k8s/                 # Kubernetes ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ
â”œâ”€â”€ docs/                    # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â”‚   â””â”€â”€ architecture.md      # ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³
â””â”€â”€ docker-compose.yml       # ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ Docker Compose
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆ

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

```bash
cd backend
cargo test
```

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

```bash
cd frontend
yarn test        # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ (vitest)
yarn test:e2e    # E2E ãƒ†ã‚¹ãƒˆ (playwright)
```

## ğŸ”§ é–‹ç™ºã‚³ãƒãƒ³ãƒ‰

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

```bash
# ãƒ“ãƒ«ãƒ‰
cargo build

# ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
cargo fmt

# ãƒªãƒ³ãƒˆ
cargo clippy

# Worker ã‚’èµ·å‹•
cargo run --bin worker
```

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

```bash
# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼
yarn dev

# ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
yarn build

# ãƒªãƒ³ãƒˆ
yarn lint

# ãƒ†ã‚¹ãƒˆ (watch ãƒ¢ãƒ¼ãƒ‰)
yarn test
```

## ğŸ³ Docker ãƒ“ãƒ«ãƒ‰

```bash
# API ã‚µãƒ¼ãƒãƒ¼
docker build -t db-viewer-api ./backend

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
docker build -t db-viewer-frontend ./frontend
```

## â˜¸ï¸ Kubernetes ãƒ‡ãƒ—ãƒ­ã‚¤

```bash
# åå‰ç©ºé–“ã‚’ä½œæˆ
kubectl apply -f deploy/k8s/namespace.yaml

# ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½œæˆ (ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç·¨é›†)
cp deploy/k8s/secret.template.yaml deploy/k8s/secret.yaml
# secret.yaml ã‚’ç·¨é›†ã—ã¦å®Ÿéš›ã®å€¤ã‚’è¨­å®š
kubectl apply -f deploy/k8s/secret.yaml

# å…¨ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
kubectl apply -f deploy/k8s/
```

## ğŸ“Š API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|--------------|---------|------|
| `/health` | GET | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ |
| `/api/dumps` | GET | ãƒ€ãƒ³ãƒ—ä¸€è¦§å–å¾— |
| `/api/dumps` | POST | æ–°è¦ãƒ€ãƒ³ãƒ—ä½œæˆ |
| `/api/dumps/{id}` | GET | ãƒ€ãƒ³ãƒ—è©³ç´°å–å¾— |
| `/api/dumps/{id}/upload` | POST | ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ |
| `/api/dumps/{id}/schema` | GET | ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±å–å¾— |
| `/api/dumps/{id}/tables/{schema}/{table}` | GET | ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿å–å¾— |
| `/api/dumps/{id}/explain` | POST | ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è§£èª¬ |
| `/api/dumps/{id}/risk/{schema}/{table}` | GET | ãƒ†ãƒ¼ãƒ–ãƒ«ãƒªã‚¹ã‚¯è©•ä¾¡ |
